version: '3.8'

services:
  # Main proxy on GNS3 host - with Docker API discovery enabled
  gns3-ssh-proxy-main:
    image: chistokhinsv/gns3-ssh-proxy:latest
    container_name: gns3-ssh-proxy-main
    network_mode: host
    restart: unless-stopped
    volumes:
      # Mount Docker socket (read-only) for lab proxy discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # API port (default: 8022)
      - API_PORT=8022
      # Logging level (default: INFO)
      - LOG_LEVEL=INFO
      # GNS3 server credentials for proxy discovery
      - GNS3_HOST=localhost
      - GNS3_PORT=80
      - GNS3_USERNAME=admin
      - GNS3_PASSWORD=${GNS3_PASSWORD}  # Set in .env file
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8022/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Example: Lab proxy template (used inside GNS3 projects)
  # This is just a reference - lab proxies are created by GNS3 from templates
  # gns3-ssh-proxy-lab:
  #   image: chistokhinsv/gns3-ssh-proxy:latest
  #   container_name: A-PROXY
  #   network_mode: host
  #   restart: unless-stopped
  #   # NO Docker socket mount - lab proxies don't need discovery
  #   environment:
  #     - API_PORT=8022
  #     - LOG_LEVEL=INFO
  #   # Note: Network configuration done via GNS3 MCP tools or manually
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8022/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s

# For production deployment, create .env file with:
# GNS3_PASSWORD=your-gns3-password
