services:
  # Main proxy on GNS3 host - with Docker API discovery enabled
  gns3-ssh-proxy-main:
    image: chistokhinsv/gns3-ssh-proxy:latest
    container_name: gns3-ssh-proxy-main
    network_mode: host
    pid: host  # Required for ubridge process discovery (v0.4.1)
    restart: unless-stopped
    volumes:
      # Mount Docker socket (read-only) for lab proxy discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount directory for sharing scripts/configs with host
      - /opt/gns3-ssh-proxy:/opt/gns3-ssh-proxy
    environment:
      # API port (default: 8022)
      - API_PORT=${API_PORT:-8022}
      # Logging level (default: INFO)
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # GNS3 controller credentials (CONTROLLER_ prefix, GNS3 filters GNS3_*)
      - CONTROLLER_HOST=${CONTROLLER_HOST:-localhost}
      - CONTROLLER_PORT=${CONTROLLER_PORT:-80}
      - CONTROLLER_USERNAME=${CONTROLLER_USERNAME:-admin}
      - CONTROLLER_PASSWORD=${CONTROLLER_PASSWORD:-}  # Set in .env file
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8022/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
