# GNS3 SSH Proxy - Nginx Unified Port Configuration
# Single port (8022) serves static files, FastAPI, and device reverse proxy
# v0.4.0: Added static files for topology viewer at root path
# GNS3 console port → 8022 → nginx → routes to static/FastAPI/devices

upstream fastapi {
    server 127.0.0.1:8080;
}

server {
    listen 8022;
    server_name _;

    # Static files root for topology viewer (v0.4.0)
    root /app/static;
    index index.html;

    # Disable access log for reverse proxy (use FastAPI logging)
    access_log off;
    error_log /var/log/nginx/error.log warn;

    # Increase timeouts for long-running device operations
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # WebSocket support for modern device UIs
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Disable SSL verification for device backends
    proxy_ssl_verify off;

    # =========================================================================
    # API endpoints -> FastAPI (v0.4.0: widget management API)
    # =========================================================================
    location /api/ {
        proxy_pass http://fastapi/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =========================================================================
    # Existing FastAPI endpoints (preserve backward compatibility)
    # =========================================================================
    location /health {
        proxy_pass http://fastapi/health;
    }

    location /version {
        proxy_pass http://fastapi/version;
    }

    # v0.4.4: Widget Manager UI
    location /widgets {
        proxy_pass http://fastapi/widgets;
    }

    location /ssh/ {
        proxy_pass http://fastapi/ssh/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /tftp {
        proxy_pass http://fastapi/tftp;
    }

    location /http-client {
        proxy_pass http://fastapi/http-client;
    }

    location /proxy/ {
        proxy_pass http://fastapi/proxy/;
    }

    location /local/ {
        proxy_pass http://fastapi/local/;
    }

    # =========================================================================
    # Device HTTP reverse proxy (existing)
    # =========================================================================
    # Dynamic upstream configuration via FastAPI management
    # URL format: /http-proxy/{device_ip}:{port}/path
    # Example: /http-proxy/10.1.1.1:80/ -> http://10.1.1.1:80/
    # Example: /http-proxy/10.1.1.1:443/ -> https://10.1.1.1:443/

    location ~ ^/http-proxy/([^/]+):(\d+)/(.*)$ {
        set $backend_host $1;
        set $backend_port $2;
        set $backend_path $3;

        # Determine protocol (assume HTTPS for port 443, HTTP otherwise)
        set $backend_proto "http";
        if ($backend_port = 443) {
            set $backend_proto "https";
        }

        # Proxy to backend
        proxy_pass $backend_proto://$backend_host:$backend_port/$backend_path$is_args$args;

        # Allow all methods (GET, POST, PUT, DELETE, etc.)
        proxy_method $request_method;

        # Pass request body
        proxy_pass_request_body on;

        # Rewrite redirects to go through proxy
        proxy_redirect / /http-proxy/$backend_host:$backend_port/;
    }

    # =========================================================================
    # Health checks
    # =========================================================================
    location /nginx-health {
        access_log off;
        return 200 "nginx reverse proxy healthy\n";
        add_header Content-Type text/plain;
    }

    # =========================================================================
    # Default: Static files with SPA fallback (v0.4.0)
    # =========================================================================
    location / {
        try_files $uri $uri/ /index.html;
    }
}
