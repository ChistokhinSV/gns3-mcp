# GNS3 SSH Proxy - Nginx Unified Port Configuration
# Single port (8022) serves both FastAPI and device reverse proxy
# GNS3 console port → 8022 → nginx → routes to FastAPI or devices

upstream fastapi {
    server 127.0.0.1:8080;
}

server {
    listen 8022;
    server_name _;

    # Disable access log for reverse proxy (use FastAPI logging)
    access_log off;
    error_log /var/log/nginx/error.log warn;

    # Increase timeouts for long-running device operations
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # WebSocket support for modern device UIs
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Disable SSL verification for device backends
    proxy_ssl_verify off;

    # Dynamic upstream configuration via FastAPI management
    # URL format: /http-proxy/{device_ip}:{port}/path
    # Example: /http-proxy/10.1.1.1:80/ -> http://10.1.1.1:80/
    # Example: /http-proxy/10.1.1.1:443/ -> https://10.1.1.1:443/

    location ~ ^/http-proxy/([^/]+):(\d+)/(.*)$ {
        set $backend_host $1;
        set $backend_port $2;
        set $backend_path $3;

        # Determine protocol (assume HTTPS for port 443, HTTP otherwise)
        set $backend_proto "http";
        if ($backend_port = 443) {
            set $backend_proto "https";
        }

        # Proxy to backend
        proxy_pass $backend_proto://$backend_host:$backend_port/$backend_path$is_args$args;

        # Allow all methods (GET, POST, PUT, DELETE, etc.)
        proxy_method $request_method;

        # Pass request body
        proxy_pass_request_body on;

        # Rewrite redirects to go through proxy
        proxy_redirect / /http-proxy/$backend_host:$backend_port/;
    }

    # Health check endpoint
    location /nginx-health {
        access_log off;
        return 200 "nginx reverse proxy healthy\n";
        add_header Content-Type text/plain;
    }

    # Default location: proxy all other requests to FastAPI
    location / {
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
