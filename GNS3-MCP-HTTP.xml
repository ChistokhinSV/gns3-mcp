<?xml version="1.0" encoding="UTF-8"?>
<!--
  WinSW Configuration for GNS3 MCP HTTP Server

  WinSW Documentation: https://github.com/winsw/winsw/blob/v3/docs/xml-config-file.md

  This configuration runs the MCP server as a Windows service with:
  - Automatic startup
  - Graceful shutdown with 30s timeout
  - Log rotation (10MB max)
  - Console window hidden in production
-->
<service>
  <id>GNS3-MCP-HTTP</id>
  <name>GNS3 MCP HTTP Server</name>
  <description>MCP server providing HTTP access to GNS3 network labs</description>

  <!-- Executable and Arguments -->
  <!-- Uses wrapper script to find and run uvx (handles PATH issues in service context) -->
  <executable>%BASE%\run-uvx.cmd</executable>
  <arguments>--from "%BASE%" gns3-mcp --transport http --http-port 8100</arguments>
  <workingdirectory>%BASE%</workingdirectory>

  <!-- Service Mode -->
  <serviceaccount>
    <domain></domain>
    <user>.\GNS3MCPService</user>
    <password>GNS3mcp!2025</password>
    <allowservicelogon>true</allowservicelogon>
  </serviceaccount>

  <!-- Startup Mode -->
  <startmode>Automatic</startmode>

  <!-- Logging -->
  <log mode="roll-by-size">
    <sizeThreshold>10240</sizeThreshold> <!-- 10MB -->
    <keepFiles>3</keepFiles>
  </log>
  <logpath>%BASE%</logpath>
  <logmode>rotate</logmode>

  <!-- Graceful Shutdown Configuration -->
  <!-- WinSW sends Ctrl+C (SIGINT) on stop, which our signal handler catches -->
  <stopparentprocessfirst>false</stopparentprocessfirst>
  <stoptimeout>30sec</stoptimeout> <!-- Allow 30s for graceful shutdown -->

  <!-- Process Priority -->
  <priority>Normal</priority>

  <!-- Environment Variables -->
  <!-- Python settings -->
  <env name="PYTHONUNBUFFERED" value="1"/>
  <env name="PYTHONIOENCODING" value="utf-8"/>

  <!-- GNS3 Server Configuration -->
  <!-- These must be set as Windows system/user environment variables -->
  <!-- Example (PowerShell as Admin):
       [Environment]::SetEnvironmentVariable("GNS3_USER", "admin", "Machine")
       [Environment]::SetEnvironmentVariable("GNS3_PASSWORD", "your-password", "Machine")
       [Environment]::SetEnvironmentVariable("GNS3_HOST", "192.168.1.20", "Machine")
       [Environment]::SetEnvironmentVariable("GNS3_PORT", "80", "Machine")
  -->
  <env name="GNS3_USER" value="%GNS3_USER%"/>
  <env name="GNS3_PASSWORD" value="%GNS3_PASSWORD%"/>
  <env name="GNS3_HOST" value="%GNS3_HOST%"/>
  <env name="GNS3_PORT" value="%GNS3_PORT%"/>

  <!-- MCP HTTP Server Configuration -->
  <env name="HTTP_HOST" value="%HTTP_HOST%"/>
  <env name="HTTP_PORT" value="8100"/>
  <env name="LOG_LEVEL" value="%LOG_LEVEL%"/>
  <env name="MCP_API_KEY" value="%MCP_API_KEY%"/>

  <!-- GNS3 HTTPS Support (optional) -->
  <env name="GNS3_USE_HTTPS" value="%GNS3_USE_HTTPS%"/>
  <env name="GNS3_VERIFY_SSL" value="%GNS3_VERIFY_SSL%"/>
</service>
