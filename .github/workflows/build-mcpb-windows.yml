name: Build Windows MCP Extension

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download UV package manager
        run: |
          Write-Host "Downloading UV package manager for Windows..."
          $uvUrl = "https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-pc-windows-msvc.zip"
          $uvZip = "uv-windows.zip"
          Invoke-WebRequest -Uri $uvUrl -OutFile $uvZip
          Write-Host "Extracting UV binary..."
          Expand-Archive -Path $uvZip -DestinationPath mcp-server -Force
          Remove-Item $uvZip
          Write-Host "UV binary downloaded successfully"
          Get-Item mcp-server\uv.exe | Format-List

      - name: Install build tools for PyPI
        run: |
          pip install build twine

      - name: Copy source code for packaging
        run: |
          Write-Host "Copying gns3_mcp\ source code into mcp-server\ for .mcpb packaging..."
          if (Test-Path mcp-server\gns3_mcp) {
            Remove-Item -Path mcp-server\gns3_mcp -Recurse -Force
          }
          Copy-Item -Path gns3_mcp -Destination mcp-server\gns3_mcp -Recurse -Force
          Write-Host "Source code copied successfully"

      - name: Build MCP binary
        run: |
          cd mcp-server
          npx @anthropic-ai/mcpb@1.1.2 pack

      - name: Verify build output
        run: |
          if (!(Test-Path mcp-server\mcp-server.mcpb)) {
            Write-Host "Error: mcp-server.mcpb was not created"
            exit 1
          }
          Write-Host "Build successful:"
          Get-Item mcp-server\mcp-server.mcpb | Format-List

          # Verify UV binary is included (size should be ~22 MB with UV binary)
          $SizeMB = [math]::Round((Get-Item mcp-server\mcp-server.mcpb).Length / 1MB)
          if ($SizeMB -lt 20) {
            Write-Host "ERROR: .mcpb size is ${SizeMB}M - UV binary likely missing!"
            Write-Host "Expected size: ~22 MB (compressed, includes 58 MB UV binary)"
            Write-Host "Actual size: $SizeMB MB"
            exit 1
          }
          Write-Host "Size check passed: $SizeMB MB (UV binary included)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-windows
          path: mcp-server\mcp-server.mcpb
          retention-days: 30

      - name: Extract version and check for tag
        id: version
        run: |
          $manifest = Get-Content mcp-server\manifest.json | ConvertFrom-Json
          $version = $manifest.version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"

          # Check if current commit has a version tag
          $tag = git describe --exact-match --tags HEAD 2>$null
          if ($tag -match "^v") {
            echo "is_tagged=true" >> $env:GITHUB_OUTPUT
            Write-Host "This commit is tagged for release"
          } else {
            echo "is_tagged=false" >> $env:GITHUB_OUTPUT
            Write-Host "This commit is not tagged"
          }

      - name: Build PyPI distributions
        if: steps.version.outputs.is_tagged == 'true'
        run: |
          python -m build
          Get-ChildItem dist\

      - name: Publish to PyPI
        if: steps.version.outputs.is_tagged == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m twine upload dist\*

      - name: Create Release
        if: steps.version.outputs.is_tagged == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mcp-server/mcp-server.mcpb
            dist/*.whl
            dist/*.tar.gz
          tag_name: v${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }} (Windows)
          body: |
            ## GNS3 MCP Server v${{ steps.version.outputs.version }} (Windows Build)

            ### ðŸš€ Performance Improvements (v0.45.0)
            - **UV Package Manager Integration**: 10-100Ã— faster dependency installation
            - **Bootstrap time**: 70s â†’ 6-10s (7Ã— faster)
            - **MCP timeout compliance**: âœ… Fits within 60-second initialization timeout
            - **Runtime dependencies**: Installed on-demand from bundled UV binary (58 MB)

            ### Installation

            **Via pip (Recommended):**
            ```bash
            pip install gns3-mcp
            ```

            **Via Claude Desktop:**
            Download `mcp-server.mcpb` and install via Claude Desktop settings.

            ### Changes
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.

            ### Platform
            - Windows-compatible binaries (Python 3.10-3.13)
            - Built on: windows-latest runner
            - Package size: ~22 MB (compressed)
          draft: false
          prerelease: false
